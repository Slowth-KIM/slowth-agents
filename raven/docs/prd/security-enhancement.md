# PRD: Security Enhancement - 위험 패턴 감지 훅

## Overview

| Field | Value |
|-------|-------|
| **Task ID** | security-enhancement |
| **Title** | 위험 패턴 감지 및 방지 Hook 구현 |
| **Priority** | High |
| **Created** | 2026-01-11 |
| **Status** | Draft |

## Problem Statement

AI 에이전트가 자율적으로 작업할 때 잠재적으로 위험한 명령을 실행할 수 있습니다:

1. **다중 Bash 실행**: 여러 Bash 명령을 병렬로 실행하여 시스템 과부하
2. **파괴적 명령**: `rm -rf`, `git reset --hard` 등 복구 불가 작업
3. **민감 파일 수정**: `.env`, 인증 파일 등 접근
4. **무한 루프**: 재귀적 스크립트 실행

## Goals

PreToolUse hook을 활용한 위험 패턴 감지 및 차단:

1. **패턴 감지**: 위험한 명령 패턴 사전 차단
2. **사용자 확인**: 위험 명령 실행 전 확인 요청
3. **로깅**: 차단된 명령 기록
4. **설정 가능**: 프로젝트별 규칙 커스터마이징

## Non-Goals

- 완전한 샌드박싱 (OS 레벨 격리)
- 네트워크 요청 모니터링
- 실시간 자원 사용량 제한

## Architecture

### Hook 구조

```
.claude/
├── hooks/
│   ├── hooks.json                  # Hook 정의
│   ├── raven-stop-hook.sh          # Stop hook (loop용)
│   └── raven-security-hook.sh      # Security hook
└── raven-security.local.md         # 보안 규칙 설정
```

### 보안 규칙 설정

`.claude/raven-security.local.md`:
```yaml
---
enabled: true
log_blocked: true
---

# Raven Security Rules

## Blocked Patterns (차단)
- `rm -rf /`
- `rm -rf ~`
- `git push --force origin main`
- `git reset --hard`
- `chmod 777`

## Confirm Patterns (확인 필요)
- `rm -rf`
- `git push --force`
- `npm publish`
- `docker system prune`

## Protected Files (수정 차단)
- `.env`
- `.env.local`
- `*.pem`
- `*credentials*`

## Max Parallel Bash
- limit: 3
```

### PreToolUse Hook Flow

```
[Agent] Bash("rm -rf node_modules") 실행 시도
          ↓
[PreToolUse Hook]
  ├─ raven-security.local.md 로드
  ├─ 패턴 매칭:
  │    ├─ Blocked → block + 경고 메시지
  │    ├─ Confirm → 사용자 확인 요청
  │    └─ Allowed → 통과
  └─ Protected Files 체크:
       ├─ 매칭 → block
       └─ 비매칭 → 통과
```

## Implementation Plan

### Phase 1: Hook Infrastructure

1. `hooks.json`에 PreToolUse hook 추가
2. `raven-security-hook.sh` 스크립트 생성
3. 기본 보안 규칙 템플릿 생성

### Phase 2: Pattern Matching

Bash 명령 패턴 매칭:
- 정규식 기반 매칭
- 파일 경로 분석
- 플래그 조합 감지

### Phase 3: Multi-Bash Detection

동시 Bash 호출 감지:
- 현재 실행 중인 Bash 카운트 추적
- 임계값 초과 시 경고/차단

### Phase 4: Logging & Reporting

차단된 명령 로깅:
- `.claude/security-log.local.md`에 기록
- 날짜, 명령, 차단 사유 포함

## Implementation Details

### hooks.json 업데이트

```json
{
  "description": "Raven plugin hooks",
  "hooks": {
    "Stop": [...],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/raven-security-hook.sh"
          }
        ]
      },
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/raven-security-hook.sh"
          }
        ]
      }
    ]
  }
}
```

### raven-security-hook.sh

핵심 로직:
1. stdin에서 tool_input JSON 읽기
2. 도구 타입별 분기:
   - Bash: 명령어 패턴 검사
   - Edit/Write: 파일 경로 검사
3. 규칙 매칭 결과에 따라 allow/block/confirm 반환

### 출력 형식

```json
// 허용
{ "decision": "allow" }

// 차단
{
  "decision": "block",
  "reason": "Blocked: rm -rf with root path is not allowed"
}

// 확인 필요
{
  "decision": "block",
  "reason": "This command requires confirmation: git push --force\nPlease confirm by running the command again with --confirmed flag"
}
```

## Acceptance Criteria

- [ ] PreToolUse hook이 Bash 명령 가로채기
- [ ] 차단 패턴 명령 실행 시 에러 메시지 표시
- [ ] 확인 패턴 명령 실행 시 경고 메시지 표시
- [ ] Protected Files 수정 시 차단
- [ ] 차단된 명령이 로그 파일에 기록
- [ ] 보안 규칙 커스터마이징 가능

## Technical Constraints

1. **Claude Code 호환**: PreToolUse hook API 준수
2. **성능**: 각 명령 검사 100ms 이내
3. **유연성**: 프로젝트별 규칙 오버라이드 가능
4. **기본값**: 최소한의 차단, 대부분 경고

## Security Patterns Reference

### 절대 차단 (Blocked)

| 패턴 | 위험도 | 이유 |
|------|--------|------|
| `rm -rf /` | Critical | 시스템 전체 삭제 |
| `rm -rf ~` | Critical | 홈 디렉토리 삭제 |
| `:(){ :\|:& };:` | Critical | Fork bomb |
| `chmod -R 777 /` | High | 권한 완전 개방 |
| `git push --force origin main` | High | 메인 브랜치 강제 푸시 |

### 확인 필요 (Confirm)

| 패턴 | 이유 |
|------|------|
| `rm -rf` | 재귀적 삭제 |
| `git push --force` | 강제 푸시 |
| `npm publish` | 패키지 배포 |
| `docker system prune` | Docker 정리 |
| `DROP TABLE` | DB 테이블 삭제 |

### 보호 파일 (Protected)

- `.env*` - 환경 변수
- `*.pem`, `*.key` - 인증서/키
- `*credentials*`, `*secret*` - 인증 정보
- `id_rsa*` - SSH 키

## Success Metrics

1. 위험 명령 실행 0건
2. False positive (정상 명령 오차단) < 5%
3. 보안 규칙 커버리지 > 90%

## Open Questions

1. 확인 후 실행 메커니즘 구현 방법?
2. 규칙 자동 업데이트 방법?
3. 팀 공유 규칙 vs 개인 규칙 분리?

---

*Generated by Raven Init Agent*
