# PRD: Ralph-Wiggum Integration - 자율 루프 기능

## Overview

| Field | Value |
|-------|-------|
| **Task ID** | ralph-wiggum-integration |
| **Title** | Ralph-Wiggum 자율 루프 기능 통합 |
| **Priority** | High |
| **Created** | 2026-01-11 |
| **Status** | Draft |

## Problem Statement

현재 Raven 에이전트들은 작업 완료 후 사용자의 다음 지시를 기다립니다. 복잡한 기능 구현이나 다단계 작업에서:

1. **수동 반복 필요**: 각 단계마다 사용자가 "계속해" 입력 필요
2. **야간 작업 불가**: 사용자가 자리를 비우면 진행 중단
3. **긴 작업 비효율**: 테스트-수정-테스트 사이클에 사용자 개입 필요

## Goals

Ralph-Wiggum의 자율 루프 패턴을 Raven에 통합:

1. **자율 반복**: 완료 조건까지 자동으로 작업 반복
2. **Stop Hook 통합**: 세션 종료 시 동일 프롬프트 재입력
3. **안전한 종료**: 완료 조건 충족 또는 max iterations 도달 시 종료
4. **진행 상태 추적**: iteration 카운트 및 진행 상황 저장

## Non-Goals

- 외부 bash 루프 사용 (Stop Hook으로 내부 구현)
- 여러 프롬프트 순차 실행 (단일 프롬프트 반복만)
- 자동 에이전트 전환 (수동 핸드오프 유지)

## Architecture

### Stop Hook 구조

```
.claude/
├── hooks/
│   ├── hooks.json              # Hook 정의
│   ├── raven-stop-hook.sh      # Stop hook 스크립트
│   └── raven-security-hook.sh  # Security hook (별도 PRD)
```

### 상태 파일

```
.claude/raven-loop.local.md
---
iteration: 1
max_iterations: 50
completion_promise: "COMPLETE"
agent: raven-coding
task_id: implement-feature
started_at: ISO timestamp
---

# Loop Prompt

구현할 기능 설명...

완료 조건:
- 모든 테스트 통과
- 빌드 성공
- 완료 시 <promise>COMPLETE</promise> 출력
```

### Hook Flow

```
[사용자] /raven:code loop "프롬프트" --max 30
          ↓
[raven-coding] 작업 수행
          ↓
[Claude] 종료 시도
          ↓
[Stop Hook]
  ├─ .claude/raven-loop.local.md 확인
  ├─ <promise> 태그 검사
  │    ├─ 일치 → 종료 허용, 상태 파일 삭제
  │    └─ 불일치 → block + 같은 프롬프트 재입력
  └─ iteration++ 후 계속
```

## Implementation Plan

### Phase 1: Hook Infrastructure

1. `.claude/hooks/` 디렉토리 생성
2. `hooks.json` 작성 (Stop hook 정의)
3. `raven-stop-hook.sh` 스크립트 생성

### Phase 2: Loop Command

`/raven:code loop` 명령 추가:

```bash
/raven:code loop "프롬프트" --max-iterations 30 --completion-promise "DONE"
```

동작:
1. `.claude/raven-loop.local.md` 생성
2. 프롬프트와 설정 저장
3. 작업 시작

### Phase 3: Agent Integration

raven-coding agent에 loop 모드 지원:
- Startup 시 `raven-loop.local.md` 확인
- Loop 모드면 프롬프트 자동 실행
- 진행 상황을 working.json에도 동기화

### Phase 4: Safety Features

- `--max-iterations` 기본값 30
- `<promise>` 태그 없으면 무한 루프 경고
- `/raven:cancel-loop` 명령으로 수동 취소
- iteration마다 진행 상황 로그

## Implementation Details

### hooks.json

```json
{
  "description": "Raven autonomous loop hooks",
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/raven-stop-hook.sh"
          }
        ]
      }
    ]
  }
}
```

### raven-stop-hook.sh

핵심 로직:
1. `.claude/raven-loop.local.md` 존재 확인
2. transcript에서 마지막 assistant 메시지 추출
3. `<promise>` 태그 내용과 completion_promise 비교
4. 일치하면 종료 허용, 불일치하면 block + 프롬프트 재입력

### cancel-loop 명령

`.claude/commands/cancel-loop.md`:
- `.claude/raven-loop.local.md` 삭제
- 현재 iteration 정보 출력
- 작업 요약 저장

## Acceptance Criteria

- [ ] `/raven:code loop` 명령으로 자율 루프 시작
- [ ] Stop hook이 정상 동작 (종료 가로채기)
- [ ] `<promise>` 태그로 완료 조건 충족 시 종료
- [ ] `--max-iterations` 도달 시 자동 종료
- [ ] `/raven:cancel-loop`으로 수동 취소 가능
- [ ] iteration 카운트가 상태 파일에 저장됨
- [ ] 중단 후 재시작 시 이전 iteration 이어서 진행

## Technical Constraints

1. **Claude Code 호환**: Stop hook API 준수
2. **jq 필수**: JSON 파싱에 사용
3. **Perl 권장**: 멀티라인 정규식 처리
4. **상태 파일**: `.local.md`로 git ignore

## Success Metrics

1. 자율 루프로 테스트-수정 사이클 자동화
2. 야간 작업 가능 (사용자 부재 시에도 진행)
3. 복잡한 구현 작업 80% 자동화

## Open Questions

1. 에러 발생 시 자동 재시도 횟수?
2. 루프 중 사용자 개입 허용 방법?
3. 여러 프롬프트 순차 실행 지원 여부?

---

*Generated by Raven Init Agent*
